@using FSH.Starter.Blazor.Modules.Document.Blazor.Components.FileExplorer.Models
@using FSH.Starter.Blazor.Modules.Document.Blazor.Components.FileExplorer.Services

@inject  IFileExplorerStateService StateService

<MudItem xs="6" sm="4" md="3" lg="2">
  <MudPaper @onclick="ToggleSelected" Class="@GetSelectClass()" Style="text-align:center">
    <LoadingCard DataLoaded="DataLoaded">
      <SkeletonView>
        <DefaultFileViewSkeleton />
      </SkeletonView>
      <ContentView>
        @ChildContent
      </ContentView>
    </LoadingCard>
  </MudPaper>
</MudItem>

@code {
  [CascadingParameter(Name = "CurrentFolder")] public FolderModel CurrentFolder { get; set; } = default!;
  [Parameter, EditorRequired] public bool DataLoaded { get; set; } = false;
  [Parameter] public RenderFragment? ChildContent { get; set; } // The default slot
  [Parameter] public FolderModel? Model { get; set; }
  [Parameter] public EventCallback SelectionChanged { get; set; }

  private string GetSelectClass()
  {
    return Model.IsSelected ? "mud-height-full default-file-view selected" : "mud-height-full default-file-view ";
  }
  protected override void OnInitialized()
  {
    StateService.OnFileSelectionChanged += StateHasChangedHandler;
    base.OnInitialized();
  }

  public void StateHasChangedHandler()
  {
    // Optionally update local values
    // ...
    InvokeAsync(StateHasChanged); // Ensure the UI update happens on the correct thread
  }
  private void ToggleSelected()
  {
    // foreach (var folder in CurrentFolder.Folders)
    // {
    //   folder.UnSelect();
    // }
    // foreach (var file in CurrentFolder.Files)
    // {
    //   file.UnSelect();
    // }
    StateService.NotifyFileExplorerClearSelection();
    if (Model.IsSelected)
    {
      Model.UnSelect();
    }
    else
    {
      Model.Select();
    }
    StateService.NotifyFileSelectionChanged();
    StateService.NotifyStateChanged();
  }


  public void Dispose()
  {
    StateService.OnFileSelectionChanged -= StateHasChangedHandler;
  }
}

<style>
  .default-file-view {
    cursor: pointer;
    padding: 8px;
    border: 2px solid transparent;
    transition: border-color 0.3s;
  }

    .default-file-view:hover {
      border-color: var(--mud-palette-primary);
    }

    .default-file-view.selected {
      border-color: var(--mud-palette-secondary);
      background-color: var(--mud-palette-secondary-lighten-5);
    }
</style>

