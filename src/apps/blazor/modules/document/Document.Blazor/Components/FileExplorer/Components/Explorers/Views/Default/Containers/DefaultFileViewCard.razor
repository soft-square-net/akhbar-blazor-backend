@using FSH.Starter.Blazor.Modules.Document.Blazor.Components.FileExplorer.Models
@using FSH.Starter.Blazor.Modules.Document.Blazor.Components.FileExplorer.Services

@inject  IFileExplorerStateService StateService

@* <MudItem xs="6" sm="4" md="3" lg="2"> *@
<MudPaper @onclick="ToggleSelected" Width="100px" Class="@($" d-flex {GetSelectClass()}")">
    <LoadingCard DataLoaded="DataLoaded">
      <SkeletonView>
        <DefaultFileViewSkeleton />
      </SkeletonView>
      <ContentView>
        @ChildContent
      </ContentView>
    </LoadingCard>
  </MudPaper>
@* </MudItem> *@

@code {
  [CascadingParameter(Name = "CurrentFolder")] public FolderModel CurrentFolder { get; set; } = default!;
  [Parameter, EditorRequired] public bool DataLoaded { get; set; } = false;
  [Parameter] public RenderFragment? ChildContent { get; set; } // The default slot
  [Parameter] public FileModel? Model { get; set; }
  [Parameter] public EventCallback SelectionChanged { get; set; }

  // private string _class { get; set; } = string.Empty;
  // private string CssClass 
  // {
  //   get{ 
  //     _class = Model.IsSelected ? "mud-height-full default-file-view selected" : "mud-height-full default-file-view "; 
  //     return _class;
  //   }
  //   set { _class = value; }
  // }
  private string GetSelectClass()
  {
    return Model.IsSelected ? "mud-height-full default-file-view selected" : "mud-height-full default-file-view ";
  }
  protected override void OnInitialized()
  {
    StateService.OnFileSelectionChanged += StateHasChangedHandler;
    base.OnInitialized();
  }

  public void StateHasChangedHandler()
  {
    // Optionally update local values
    // ...
    InvokeAsync(StateHasChanged); // Ensure the UI update happens on the correct thread
  }
  private void ToggleSelected()
  {
    // foreach (var folder in CurrentFolder.Folders)
    // {
    //   folder.UnSelect();
    // }
    // foreach (var file in CurrentFolder.Files)
    // {
    //   file.UnSelect();
    // }

    StateService.NotifyFileExplorerClearSelection();

    if (Model.IsSelected)
    {
      // CssClass = "mud-height-full default-file-view ";
      Model.UnSelect();
    }
    else
    {
      // CssClass = "mud-height-full default-file-view selected ";
      Model.Select();
    }
    StateService.NotifyFileSelectionChanged();
    StateService.NotifyStateChanged();
  }

  private void UpdateView()
  {
    // Blazor automatically re-renders the parent after an event handler is invoked.
  }

  public void Dispose()
  {
    StateService.OnFileSelectionChanged -= StateHasChangedHandler;
  }
}

<style>
  .default-file-view {
    cursor: pointer;
    padding-block: 8px;
    padding-inline: 0 !important;
    border: 2px solid transparent;
    transition: border-color 0.3s;
    text-align: center;
    height:auto;
  }

    .default-file-view:hover {
      /* border-color: var(--mud-palette-primary);
        background-color: var(--mud-palette-secondary-lighten-5);*/
      border-color: @Color.Primary;
      background-color: @Colors.Blue.Lighten2;
    }

    .default-file-view.selected {
      border-color: var(--mud-palette-secondary);
      background-color: var(--mud-palette-secondary-lighten-5);
    }
</style>

